<div class="rating-list-container">
  <div class="header">
    <h2>Tous les avis sur les vols</h2>
    <div class="header-actions">
      @if (!authService.isAdmin) {
        <button class="back-button" (click)="goBackToForm()">
          ‚úèÔ∏è Donner un avis
        </button>
      }
      
      <!-- Champs de filtres -->
      <div class="filters-container">
        <!-- Recherche par mot-cl√© -->
        <input 
          type="text" 
          class="filter-input" 
          placeholder="Rechercher dans les commentaires..."
          [ngModel]="searchKeyword()"
          (ngModelChange)="updateKeywordFilter($event)">

        <!-- Filtre par compagnie -->
        <select 
          class="filter-select" 
          [ngModel]="selectedCompany()"
          (ngModelChange)="updateCompanyFilter($event)">
          <option value="">Toutes les compagnies</option>
          @for (company of uniqueCompanies(); track company) {
            <option [value]="company">{{ company }}</option>
          }
        </select>

        <!-- Filtre par num√©ro de vol -->
        <select 
          class="filter-select" 
          [ngModel]="selectedFlightNumber()"
          (ngModelChange)="updateFlightNumberFilter($event)">
          <option value="">Tous les vols</option>
          @for (flightNumber of uniqueFlightNumbers(); track flightNumber) {
            <option [value]="flightNumber">{{ flightNumber }}</option>
          }
        </select>

        <!-- Filtre par statut (seulement pour les admins) -->
        @if (authService.isAdmin) {
          <select 
            class="filter-select" 
            [ngModel]="selectedStatus()"
            (ngModelChange)="updateStatusFilter($event)">
            @for (statusOption of statusOptions; track statusOption.value) {
              <option [value]="statusOption.value">{{ statusOption.label }}</option>
            }
          </select>
        }

        <!-- Filtre par date du jour -->
        <label class="filter-checkbox">
          <input 
            type="checkbox" 
            [ngModel]="showTodayOnly()"
            (ngModelChange)="showTodayOnly.set($event)">
          Vols d'aujourd'hui
        </label>

        <!-- Bouton effacer filtres -->
        <button 
          class="clear-filters-button" 
          (click)="clearAllFilters()"
          [disabled]="!searchKeyword() && !selectedCompany() && !selectedFlightNumber() && !selectedStatus() && !showTodayOnly()"
          title="Effacer tous les filtres">
          ‚úï
        </button>
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-message">
      <p>Chargement des avis...</p>
    </div>
  }

  @if (error() && !loading()) {
    <div class="error-message">
      <p>Erreur lors du chargement des avis. Veuillez r√©essayer.</p>
      <button (click)="loadRates()" class="retry-button">R√©essayer</button>
    </div>
  }

  @if (!loading() && !error() && rates().length === 0) {
    <div class="no-rates-message">
      <p>Aucun avis n'a encore √©t√© publi√©.</p>
      <button (click)="goBackToForm()" class="add-review-button">Ajouter le premier avis</button>
    </div>
  }

  @if (!loading() && !error() && rates().length > 0 && filteredRates().length === 0) {
    <div class="no-rates-message">
      <p>Aucun avis ne correspond √† vos crit√®res de recherche.</p>
      <button (click)="clearAllFilters()" class="add-review-button">Effacer les filtres</button>
    </div>
  }

  @if (!loading() && !error() && filteredRates().length > 0) {
    <div class="rates-grid">
      @for (rate of filteredRates(); track rate.id) {
        <div class="rate-card">
          <div class="rate-header">
            <div class="flight-info">
              <h3>Vol {{ rate.flightNumber }}</h3>
              <p class="airline">{{ rate.company }}</p>
              <p class="flight-date">Date du vol: {{ rate.flightDate }}</p>
            </div>
            <div class="rating-stars">
              @for (star of getStarArray(rate.rating); track $index) {
                <span class="star" [class.filled]="star">
                  ‚òÖ
                </span>
              }
              <span class="rating-number">({{ rate.rating }}/5)</span>
            </div>
          </div>
          
          <div class="rate-content">
            <p class="comment">{{ rate.comment }}</p>
          </div>

          <!-- Section des r√©ponses -->
          @if (rate.rateResponse && rate.rateResponse.length > 0) {
            <div class="rate-responses">
              <h4 class="responses-title">
                {{ rate.rateResponse.length === 1 ? 'R√©ponse de la compagnie' : 'R√©ponses de la compagnie' }}
              </h4>
              @for (response of rate.rateResponse; track response.id) {
                <div class="response-item">
                  <div class="response-content">
                    <p class="response-text">{{ response.response }}</p>
                    <p class="response-date">{{ formatDate(response.responseAt) }}</p>
                  </div>
                </div>
              }
            </div>
          }
          
          <div class="rate-footer">
            <div class="footer-content">
              <!-- Premi√®re ligne : Date de publication + Badge de statut + Boutons d'action -->
              <div class="footer-top">
                <div class="footer-left">
                  <p class="submitted-date">
                    Publi√© le {{ formatDate(rate.submittedAt ?? '') }}
                  </p>
                  <!-- Afficher le statut seulement s'il n'est pas PENDING et pour les admins -->
                  @if (authService.isAdmin && rate.status && rate.status !== 'PENDING') {
                    <span class="status-badge" [class]="getStatusClass(rate.status)">
                      {{ getStatusLabel(rate.status) }}
                    </span>
                  }
                </div>
                <div class="footer-actions">
                  <!-- Bouton "Voir d√©tail" toujours visible -->
                  <button class="detail-button" (click)="viewRateDetail(rate.id!)">
                    üëÅÔ∏è Voir d√©tail
                  </button>
                  
                  @if (authService.isAdmin) {
                    <button class="respond-button" (click)="respondToRate(rate.id!)">
                      üí¨ R√©pondre
                    </button>
                  }
                </div>
              </div>
              
              <!-- Deuxi√®me ligne : Boutons de gestion du statut (admin uniquement) -->
              @if (authService.isAdmin) {
                <div class="status-buttons">
                  @if (rate.status !== 'PUBLISHED') {
                    <button 
                      class="status-button status-publish" 
                      (click)="updateRateStatus(rate.id!, 'PUBLISHED')"
                      title="Publier l'avis">
                      ‚úì Publier
                    </button>
                  }
                  @if (rate.status !== 'PROCESSED') {
                    <button 
                      class="status-button status-process" 
                      (click)="updateRateStatus(rate.id!, 'PROCESSED')"
                      title="Marquer comme trait√©">
                      üìã Trait√©
                    </button>
                  }
                  @if (rate.status !== 'REJECTED') {
                    <button 
                      class="status-button status-reject" 
                      (click)="updateRateStatus(rate.id!, 'REJECTED')"
                      title="Rejeter l'avis">
                      ‚úó Rejeter
                    </button>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      }
    </div>
  }

  <!-- Popup de r√©ponse -->
  <app-response-popup
    #responsePopup
    (closePopup)="closeResponsePopup()"
    (responseAdded)="onResponseAdded($event)">
  </app-response-popup>
</div>
